name: Cron - Run Schedules

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  run-staging:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Trigger staging due schedules
        env:
          API_BASE_URL: ${{ secrets.STAGING_API_BASE_URL }}
          JOB_TOKEN: ${{ secrets.SCHEDULES_JOB_TOKEN_STAGING }}
        run: |
          if [ -z "$API_BASE_URL" ] || [ -z "$JOB_TOKEN" ]; then
            echo "Missing staging API base URL or job token"
            exit 1
          fi
          API_BASE_URL="${API_BASE_URL%/}"
          if [[ "$API_BASE_URL" == *"/v1" ]]; then
            echo "Invalid STAGING_API_BASE_URL: remove '/v1' from base URL"
            exit 1
          fi

          STATUS_CODE=$(curl --show-error --silent \
            -o /tmp/staging-run-due.json \
            -w "%{http_code}" \
            -X POST "$API_BASE_URL/internal/schedules/run-due" \
            -H "x-job-token: $JOB_TOKEN")

          echo "Staging run-due HTTP $STATUS_CODE"
          cat /tmp/staging-run-due.json
          echo

          if [ "$STATUS_CODE" -ge 400 ]; then
            exit 1
          fi

  run-prod:
    runs-on: ubuntu-latest
    needs: run-staging
    environment: production
    steps:
      - name: Trigger prod due schedules
        env:
          API_BASE_URL: ${{ secrets.PROD_API_BASE_URL }}
          JOB_TOKEN: ${{ secrets.SCHEDULES_JOB_TOKEN_PROD }}
        run: |
          if [ -z "$API_BASE_URL" ] || [ -z "$JOB_TOKEN" ]; then
            echo "Missing prod API base URL or job token"
            exit 1
          fi
          API_BASE_URL="${API_BASE_URL%/}"
          if [[ "$API_BASE_URL" == *"/v1" ]]; then
            echo "Invalid PROD_API_BASE_URL: remove '/v1' from base URL"
            exit 1
          fi

          STATUS_CODE=$(curl --show-error --silent \
            -o /tmp/prod-run-due.json \
            -w "%{http_code}" \
            -X POST "$API_BASE_URL/internal/schedules/run-due" \
            -H "x-job-token: $JOB_TOKEN")

          echo "Prod run-due HTTP $STATUS_CODE"
          cat /tmp/prod-run-due.json
          echo

          if [ "$STATUS_CODE" -ge 400 ]; then
            exit 1
          fi
