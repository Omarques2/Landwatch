generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  schemas  = ["app"]
}

model User {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  entraSub    String     @unique @map("entra_sub")
  entraOid    String?    @unique @map("entra_oid") @db.Uuid
  email       String?    @map("email")
  displayName String?    @map("display_name")
  status      UserStatus @default(active)
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  lastLoginAt DateTime?  @map("last_login_at") @db.Timestamptz(6)

  memberships OrgMembership[]
  groupMemberships OrgGroupMembership[]
  farms Farm[]
  analyses Analysis[] @relation("UserAnalyses")
  schedules AnalysisSchedule[] @relation("UserSchedules")

  @@index([email], map: "idx_app_user_email")
  @@map("app_user")
  @@schema("app")
}

enum UserStatus {
  pending
  active
  disabled

  @@map("user_status")
  @@schema("app")
}

model Org {
  id        String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String        @unique
  status    OrgStatus     @default(active)
  createdAt DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)

  memberships OrgMembership[]
  groups      OrgGroup[]
  apiClients  ApiClient[]
  farms       Farm[]
  analyses    Analysis[]

  @@map("org")
  @@schema("app")
}

model OrgMembership {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId     String    @map("org_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  role      OrgRole   @default(member)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId], map: "org_membership_org_user_key")
  @@map("org_membership")
  @@schema("app")
}

model OrgGroup {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId     String    @map("org_id") @db.Uuid
  name      String
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  org         Org                @relation(fields: [orgId], references: [id], onDelete: Cascade)
  memberships OrgGroupMembership[]

  @@unique([orgId, name], map: "org_group_org_name_key")
  @@map("org_group")
  @@schema("app")
}

model OrgGroupMembership {
  id        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId   String     @map("group_id") @db.Uuid
  userId    String     @map("user_id") @db.Uuid
  role      GroupRole  @default(member)
  createdAt DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)

  group OrgGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId], map: "org_group_membership_group_user_key")
  @@map("org_group_membership")
  @@schema("app")
}

model ApiClient {
  id        String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  orgId     String?        @map("org_id") @db.Uuid
  status    ApiClientStatus @default(active)
  createdAt DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)

  org   Org?     @relation(fields: [orgId], references: [id], onDelete: SetNull)
  keys  ApiKey[]

  @@map("api_client")
  @@schema("app")
}

model ApiKey {
  id         String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId   String        @map("client_id") @db.Uuid
  keyPrefix  String        @map("key_prefix")
  keyHash    String        @unique @map("key_hash")
  scopes     ApiKeyScope[]
  expiresAt  DateTime?     @map("expires_at") @db.Timestamptz(6)
  lastUsedAt DateTime?     @map("last_used_at") @db.Timestamptz(6)
  revokedAt  DateTime?     @map("revoked_at") @db.Timestamptz(6)
  createdAt  DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)

  client ApiClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId], map: "api_key_client_id_idx")
  @@index([keyPrefix], map: "api_key_prefix_idx")
  @@map("api_key")
  @@schema("app")
}

model Farm {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  carKey      String   @map("car_key")
  ownerUserId String   @map("owner_user_id") @db.Uuid
  orgId       String?  @map("org_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  owner User @relation(fields: [ownerUserId], references: [id], onDelete: Restrict)
  org   Org? @relation(fields: [orgId], references: [id], onDelete: SetNull)
  analyses Analysis[]
  schedules AnalysisSchedule[]
  alerts AnalysisAlert[]
  documents FarmDocument[]

  @@unique([carKey], map: "farm_car_key_key")
  @@index([ownerUserId], map: "farm_owner_user_id_idx")
  @@index([orgId], map: "farm_org_id_idx")
  @@map("farm")
  @@schema("app")
}

enum FarmDocType {
  CPF
  CNPJ

  @@map("farm_doc_type")
  @@schema("app")
}

model FarmDocument {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  farmId        String     @map("farm_id") @db.Uuid
  docType       FarmDocType @map("doc_type")
  docNormalized String     @map("doc_normalized")
  createdAt     DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@unique([farmId, docNormalized], map: "farm_document_unique")
  @@index([docNormalized], map: "farm_document_doc_idx")
  @@index([farmId], map: "farm_document_farm_idx")
  @@map("farm_document")
  @@schema("app")
}

model Analysis {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  carKey         String         @map("car_key")
  analysisDocs   Json           @map("analysis_docs") @default("[]")
  analysisDate   DateTime       @map("analysis_date") @db.Date
  status         AnalysisStatus @default(pending)
  createdByUserId String        @map("created_by_user_id") @db.Uuid
  orgId          String?        @map("org_id") @db.Uuid
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  completedAt    DateTime?      @map("completed_at") @db.Timestamptz(6)
  farmId         String?        @map("farm_id") @db.Uuid
  pdfStatus      AnalysisPdfStatus? @map("pdf_status")
  pdfPath        String?        @map("pdf_path")
  pdfGeneratedAt DateTime?      @map("pdf_generated_at") @db.Timestamptz(6)
  pdfExpiresAt   DateTime?      @map("pdf_expires_at") @db.Timestamptz(6)
  pdfError       String?        @map("pdf_error")
  hasIntersections Boolean      @default(false) @map("has_intersections")
  intersectionCount Int         @default(0) @map("intersection_count")
  analysisKind   AnalysisKind   @default(STANDARD) @map("analysis_kind")
  scheduleId     String?        @map("schedule_id") @db.Uuid

  results AnalysisResult[]
  cache AnalysisCache?
  alerts AnalysisAlert[]
  createdBy User @relation("UserAnalyses", fields: [createdByUserId], references: [id], onDelete: Restrict)
  org Org? @relation(fields: [orgId], references: [id], onDelete: SetNull)
  farm Farm? @relation(fields: [farmId], references: [id], onDelete: SetNull)
  schedule AnalysisSchedule? @relation("ScheduleAnalyses", fields: [scheduleId], references: [id], onDelete: SetNull)

  @@index([carKey], map: "analysis_car_key_idx")
  @@index([createdByUserId], map: "analysis_created_by_idx")
  @@index([farmId], map: "analysis_farm_id_idx")
  @@index([analysisKind], map: "analysis_kind_idx")
  @@index([scheduleId], map: "analysis_schedule_id_idx")
  @@index([status], map: "analysis_status_idx")
  @@index([pdfStatus], map: "analysis_pdf_status_idx")
  @@map("analysis")
  @@schema("app")
}

model AnalysisResult {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  analysisId         String   @map("analysis_id") @db.Uuid
  categoryCode       String   @map("category_code")
  datasetCode        String   @map("dataset_code")
  snapshotDate       DateTime? @map("snapshot_date") @db.Date
  featureId          BigInt?  @map("feature_id")
  geomId             BigInt?  @map("geom_id")
  isSicar            Boolean  @default(false) @map("is_sicar")
  sicarAreaM2        Decimal? @map("sicar_area_m2")
  featureAreaM2      Decimal? @map("feature_area_m2")
  overlapAreaM2      Decimal? @map("overlap_area_m2")
  overlapPctOfSicar  Decimal? @map("overlap_pct_of_sicar")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  analysis Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@index([analysisId], map: "analysis_result_analysis_id_idx")
  @@index([categoryCode], map: "analysis_result_category_idx")
  @@map("analysis_result")
  @@schema("app")
}

model AnalysisSchedule {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  farmId          String            @map("farm_id") @db.Uuid
  analysisKind    AnalysisKind      @map("analysis_kind")
  frequency       ScheduleFrequency
  nextRunAt       DateTime          @map("next_run_at") @db.Timestamptz(6)
  lastRunAt       DateTime?         @map("last_run_at") @db.Timestamptz(6)
  isActive        Boolean           @default(true) @map("is_active")
  timezone        String            @default("UTC")
  createdByUserId String            @map("created_by_user_id") @db.Uuid
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)

  farm      Farm          @relation(fields: [farmId], references: [id], onDelete: Cascade)
  createdBy User          @relation("UserSchedules", fields: [createdByUserId], references: [id], onDelete: Restrict)
  analyses  Analysis[]    @relation("ScheduleAnalyses")
  alerts    AnalysisAlert[]

  @@index([farmId], map: "analysis_schedule_farm_id_idx")
  @@index([isActive, nextRunAt], map: "analysis_schedule_due_idx")
  @@index([createdByUserId], map: "analysis_schedule_user_id_idx")
  @@map("analysis_schedule")
  @@schema("app")
}

model AnalysisAlert {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  farmId               String            @map("farm_id") @db.Uuid
  scheduleId           String            @map("schedule_id") @db.Uuid
  analysisId           String            @map("analysis_id") @db.Uuid
  analysisKind         AnalysisKind      @map("analysis_kind")
  alertType            AnalysisAlertType @map("alert_type")
  newIntersectionCount Int               @map("new_intersection_count")
  payload              Json              @default("{}")
  status               AnalysisAlertStatus @default(NEW)
  createdAt            DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  resolvedAt           DateTime?         @map("resolved_at") @db.Timestamptz(6)

  farm     Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)
  schedule AnalysisSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  analysis Analysis         @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@index([farmId], map: "analysis_alert_farm_id_idx")
  @@index([scheduleId], map: "analysis_alert_schedule_id_idx")
  @@index([analysisId], map: "analysis_alert_analysis_id_idx")
  @@index([status, createdAt], map: "analysis_alert_status_created_idx")
  @@map("analysis_alert")
  @@schema("app")
}

model AnalysisCache {
  analysisId String   @id @map("analysis_id") @db.Uuid
  payload    Json
  cachedAt   DateTime @default(now()) @map("cached_at") @db.Timestamptz(6)
  expiresAt  DateTime @map("expires_at") @db.Timestamptz(6)

  analysis Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@index([expiresAt], map: "analysis_cache_expires_idx")
  @@map("analysis_cache")
  @@schema("app")
}

model CnpjInfo {
  cnpj      String   @id @map("cnpj")
  nome      String?  @map("nome")
  fantasia  String?  @map("fantasia")
  situacao  String?  @map("situacao")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("cnpj_info")
  @@schema("app")
}


enum OrgStatus {
  active
  disabled

  @@map("org_status")
  @@schema("app")
}

enum OrgRole {
  owner
  admin
  member

  @@map("org_role")
  @@schema("app")
}

enum GroupRole {
  admin
  member

  @@map("org_group_role")
  @@schema("app")
}

enum ApiClientStatus {
  active
  disabled

  @@map("api_client_status")
  @@schema("app")
}

enum ApiKeyScope {
  analysis_read
  analysis_write
  pdf_read
  pdf_write

  @@map("api_key_scope")
  @@schema("app")
}

enum AnalysisStatus {
  running
  pending
  completed
  failed

  @@map("analysis_status")
  @@schema("app")
}

enum AnalysisPdfStatus {
  pending
  ready
  failed
  expired

  @@map("analysis_pdf_status")
  @@schema("app")
}

enum AnalysisKind {
  STANDARD
  DETER

  @@map("analysis_kind")
  @@schema("app")
}

enum ScheduleFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY

  @@map("schedule_frequency")
  @@schema("app")
}

enum AnalysisAlertType {
  NEW_INTERSECTION

  @@map("analysis_alert_type")
  @@schema("app")
}

enum AnalysisAlertStatus {
  NEW
  ACKNOWLEDGED

  @@map("analysis_alert_status")
  @@schema("app")
}
